{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MiniPhi Prompt Chain Response",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "step_id",
    "summary",
    "selected_options",
    "option_updates",
    "needs_more_context",
    "missing_snippets",
    "stop_reason"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "minLength": 1,
      "description": "Schema version id for the response payload."
    },
    "schema_uri": {
      "type": ["string", "null"],
      "description": "Optional schema URI reference."
    },
    "step_id": {
      "type": "string",
      "minLength": 1,
      "description": "Prompt-chain step identifier."
    },
    "summary": {
      "type": "string",
      "minLength": 1,
      "description": "Concise summary of findings or prompt adjustments."
    },
    "prompt_text": {
      "type": ["string", "null"],
      "description": "Optional rewritten prompt content."
    },
    "prompt_changes": {
      "type": "array",
      "description": "Optional, structured edits to apply to the current prompt.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["target", "change"],
        "properties": {
          "target": { "type": "string", "minLength": 1 },
          "change": { "type": "string", "minLength": 1 },
          "reason": { "type": ["string", "null"] }
        }
      },
      "default": []
    },
    "selected_options": {
      "type": "object",
      "description": "Selected option id per option set.",
      "additionalProperties": {
        "type": ["string", "null"]
      },
      "default": {}
    },
    "option_updates": {
      "type": "array",
      "description": "New options to add to future prompt runs.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["set", "options"],
        "properties": {
          "set": { "type": "string", "minLength": 1 },
          "options": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["id"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "label": { "type": ["string", "null"] },
                "description": { "type": ["string", "null"] },
                "prompt_hint": { "type": ["string", "null"] }
              }
            }
          },
          "reason": { "type": ["string", "null"] },
          "default": { "type": ["string", "null"] },
          "selected": { "type": ["string", "null"] }
        }
      },
      "default": []
    },
    "needs_more_context": {
      "type": "boolean",
      "description": "Set true when the prompt or options need more context.",
      "default": false
    },
    "missing_snippets": {
      "type": "array",
      "description": "Minimal snippets or data required before continuing.",
      "items": { "type": "string" },
      "default": []
    },
    "stop_reason": {
      "type": "string",
      "minLength": 1,
      "description": "Reason for stopping or finishing this step."
    },
    "notes": {
      "type": ["string", "null"],
      "description": "Optional notes about prompt quality or constraints."
    }
  }
}
