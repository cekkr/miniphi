{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MiniPhi Log Analysis Response",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "task",
    "root_cause",
    "summary",
    "summary_updates",
    "evidence",
    "recommended_fixes",
    "next_steps",
    "needs_more_context",
    "missing_snippets"
  ],
  "properties": {
    "task": {
      "type": "string",
      "minLength": 1,
      "description": "Repeat the operator task in <= 10 words."
    },
    "root_cause": {
      "type": ["string", "null"],
      "description": "Concise summary of the dominant finding."
    },
    "summary": {
      "type": "string",
      "description": "Natural-language final summary of the analysis (use this for info-only tasks)."
    },
    "summary_updates": {
      "type": "array",
      "description": "Short progress updates in chronological order (can be empty).",
      "items": {
        "type": "string"
      },
      "default": []
    },
    "evidence": {
      "type": "array",
      "description": "Concrete log excerpts that justify the diagnosis.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["chunk", "line_hint", "excerpt"],
        "properties": {
          "chunk": {
            "type": "string",
            "minLength": 1
          },
          "line_hint": {
            "type": ["integer", "null"]
          },
          "excerpt": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "recommended_fixes": {
      "type": "array",
      "description": "Targeted remediations with files/commands when available.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["description", "files", "commands", "owner"],
        "properties": {
          "description": {
            "type": "string",
            "minLength": 1
          },
          "files": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "commands": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": []
          },
          "owner": {
            "type": ["string", "null"]
          }
        }
      }
    },
    "next_steps": {
      "type": "array",
      "description": "Follow-up diagnostics or validations.",
      "items": {
        "type": "string"
      }
    },
    "needs_more_context": {
      "type": "boolean",
      "description": "Set to true when the captured dataset is insufficient to finish the analysis.",
      "default": false
    },
    "missing_snippets": {
      "type": "array",
      "description": "List the minimal snippets/files/commands required before proceeding.",
      "items": {
        "type": "string"
      },
      "default": []
    },
    "truncation_strategy": {
      "type": ["object", "null"],
      "description": "Plan for splitting oversized inputs and preserving must-have context across prompts. Use null when not needed.",
      "additionalProperties": false,
      "properties": {
        "should_split": {
          "type": "boolean",
          "description": "Whether the operator should split the dataset before rerunning."
        },
        "chunking_plan": {
          "type": "array",
          "description": "Proposed follow-up chunks with priorities and focus areas.",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["goal"],
            "properties": {
              "goal": {
                "type": "string",
                "minLength": 1
              },
              "priority": {
                "type": ["integer", "null"]
              },
              "lines": {
                "type": ["integer", "null"]
              },
              "context": {
                "type": ["string", "null"]
              }
            }
          },
          "default": []
        },
        "carryover_fields": {
          "type": "array",
          "description": "Fields that must persist between chunks (e.g., chunk id, last error).",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "history_schema": {
          "type": ["string", "null"],
          "description": "JSON schema (in prose) for recording context outside the current chunk."
        },
        "notes": {
          "type": ["string", "null"],
          "description": "Extra guidance for truncation or helper scripts."
        }
      }
    },
    "context_requests": {
      "type": "array",
      "description": "Optional hints that Phi needs before continuing the analysis.",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["description"],
        "properties": {
          "id": {
            "type": "string"
          },
          "description": {
            "type": "string",
            "minLength": 1
          },
          "details": {
            "type": "string"
          },
          "detail": {
            "type": "string"
          },
          "priority": {
            "type": "string",
            "enum": ["low", "mid", "high", "medium"]
          },
          "context": {
            "type": "string"
          },
          "scope": {
            "type": "string"
          },
          "source": {
            "type": "string"
          }
        }
      },
      "default": []
    }
  }
}
